# build stage
FROM node:12.18.3-buster as build-stage

USER root
ARG COMMITID

ENV TZ=Asia/Taipei
ENV symbol=\!
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

WORKDIR /app
RUN git clone http://tim:${symbol}Minnotec2025@192.168.10.8/R5012/IoMC5System.git
WORKDIR IoMC5System

RUN git checkout ${COMMITID}
RUN git rev-list --format=%B --max-count=1 ${COMMITID} > public/version.txt
RUN date +"%Y/%m/%d-%T" >> public/version.txt
RUN npm install
RUN npm run build

# production stage
FROM nginx:stable-alpine as production-stage

COPY --from=build-stage /app/IoMC5System/dist /usr/share/nginx/html
COPY --from=build-stage /app/IoMC5System/nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
